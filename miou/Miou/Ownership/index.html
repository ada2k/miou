<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Ownership (miou.Miou.Ownership)</title><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">miou</a> &#x00BB; <a href="../index.html">Miou</a> &#x00BB; Ownership</nav><header class="odoc-preamble"><h1>Module <code><span>Miou.Ownership</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#ownership-of-resources.">Ownership of resources.</a></li></ul></nav><div class="odoc-content"><h3 id="ownership-of-resources."><a href="#ownership-of-resources." class="anchor"></a>Ownership of resources.</h3><pre>La propriété, c'est le vol!</pre><p>Beyond the capitalist idea (even if certain libertarians would qualify the notion of private property), it is often useful to associate resources with the execution of a task in order to free them as soon as the said task is completed (abnormally or not).</p><p>Miou offers such a mechanism where the user can associate a resource <code>'a</code> with a promise (with <a href="#val-own"><code>own</code></a>). When the task associated with this promise is terminated, Miou will check that all the resources have been released (using <a href="#val-disown"><code>disown</code></a>). If this is not the case, Miou will call the &quot;finaliser&quot; specified by the user and fail with an &quot;uncatchable&quot; exception: <code>Resource_leak</code>.</p><p>Note that the user must release these resources <b>and</b> <a href="#val-disown"><code>disown</code></a>. In fact, <a href="#val-disown"><code>disown</code></a> does <b>not</b> call the finaliser (which is only executed in an abnormal situation: when the task has raised an exception or when a resource has not been released).</p><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The type of ownerships.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-own"><a href="#val-own" class="anchor"></a><code><span><span class="keyword">val</span> own : <span>finally:<span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>own ~finally value</code> associates the value and this finaliser with the current promise. This way, if the current promise fails abnormally, the finally function will be called.</p><pre class="language-ocaml"><code># let show () = print_endline &quot;Resource released&quot;
# Miou.run @@ fun () -&gt;
  let p = Miou.call_cc @@ fun () -&gt;
    let _ = Miou.Ownership.own ~finally:show () in
    failwith &quot;p&quot; in
  await_exn p ;;
Resource released!
Exception: Failure &quot;p&quot;.</code></pre><p><b>NOTE</b>: Finaliser can not perform OCaml's effects. This is because it is not &quot;ordered&quot; like a usual task. Using Miou functions (such as <a href="../index.html#val-await"><code>await</code></a> or <a href="../index.html#val-cancel"><code>cancel</code></a>) in the finaliser will raise an exception: <code>Effect</code>.Unhandled.</p><p>It is also important to note that if a task finishes abnormally, as well as freeing up the resources of that task, the resources owned by the children will also be freed up (hence the uselessness of using await or cancel).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-disown"><a href="#val-disown" class="anchor"></a><code><span><span class="keyword">val</span> disown : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>disown t</code> informs Miou that you have properly released the resource. If the current promise ends well and the user has not <code>disown</code> the resource, Miou raises the uncatchable exception: <code>Resource_leak</code></p><pre class="language-ocaml"><code># let show () = print_endline &quot;Resource released&quot; ;;
# Miou.run @@ fun () -&gt;
  let p = Miou.call_cc @@ fun () -&gt;
    let _ = Miou.Ownership.own ~finally:show () in
    () in
  await_exn p ;;
Resource released!
Exception: Miou.Resource_leak.</code></pre><p>Note that even in this situation, Miou calls the finaliser.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-transfer"><a href="#val-transfer" class="anchor"></a><code><span><span class="keyword">val</span> transfer : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>transfer t</code> transfers the ownership to the parent. This can be interesting when the resource is locked into a small promise in conjunction with others and the parent will make real use of it such as:</p><pre class="language-ocaml"><code># exception Timeout
# Miou.await_one
    [ Miou.call_cc (fun () -&gt;
        let socket = tcpv4 () in
        Miouu.connect socket addr;
        Ownership.transfer socket;
        socket)
    ; Miou.call @@ fun () -&gt;
      Miouu.sleep 10.; raise Timeout ]
 |&gt; function
 | Ok socket_connected -&gt; ...
 | Error Timeout -&gt; ...</code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check"><a href="#val-check" class="anchor"></a><code><span><span class="keyword">val</span> check : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>check t</code> verifies that the given resource <code>t</code> is owned by the current task. If a task tries to use a resource that does not belong to it, <a href="#val-check"><code>check</code></a> will raise an <i>uncatchable</i> exception <code>Not_owner</code>.</p></div></div></div></body></html>